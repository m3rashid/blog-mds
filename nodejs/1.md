## Creating API server in nodejs

Node.Js or Javascript in general is certainly not a very awesome programming language and definitely not the best choice for creating high performance server-side applications. But even then, it is quite popular in the industry, largely because of the community and having the same language on both frontend and the backend code. This has led to the development of the two of the most famous and on-demand tech stacks called as MERN (MongoDB, Express.Js, React.Js, Node.Js) and MEAN (same as MERN with Angular.js in place of React.Js) and many others like MEVN, MESN etc. 

Let's shift our focus today to the server side only, dealing with creating APIs with Node.Js. In this tutorial, I use Express.Js as the server framework, MongoDB as the database and other things would be discussed as the tutorial goes on.

### Motivation
The motive behind this is to give some insights on how I prefer to do certain things when creating my APIs in nodejs. This architecture is very scalable and maintainable from a developer perspective. There may be methods better than this and used widely in the industry, and you are free to choose any of them.
We will be mainly using typescript to ensure type safety in our code. 

### The folder structure
```
|
|-- .husky
|     |-- pre-commit
|
|-- .vscode
|     |-- settings.json
|     |-- extensions.json
|
|-- @types
|     |-- express
|     |     |-- index.d.ts
|     |
|     |-- xss
|     |     |-- index.d.ts
|
|-- modules
|     |-- auth
|     |     |-- controllers.ts
|     |     |-- generateKeyPair.js
|     |     |-- helpers.ts
|     |     |-- index.ts
|     |     |-- routes.ts
|     |     |-- user.model.ts
|     |     |-- validators.ts
|     |     |
|     ..    ..
|
|-- uploads
|     |-- .gitkeep
|
|-- utils
|     |-- appConfig.ts
|     |-- helpers.ts
|     |-- rateLimiter.ts
|     |-- initRouter.ts
|     |-- initValidator.ts
|
|-- .dockerignore
|-- .env.sample
|-- .env
|-- .eslintignore
|-- .eslintrc.json
|-- .gitignore
|-- .prettierignore
|-- .prettierrc.json
|-- .slugignore
|-- Dockerfile
|-- Procfile
|-- docker-compose.yml
|-- index.ts
|-- nginx.conf
|-- package.json
|-- readme.md
|-- rebuild.sh
|-- tsconfig.json
|-- yarn.lock
```

### Initial Setups
```json
// package.json

{
  "name": "Tutorial App",
  "version": "1.0.0",
  "main": "build/index.js",
  "author": "MD Rashid Hussain <m3rashid.hussain@gmail.com>",
  "license": "MIT",
  "scripts": {
    "ci": "yarn install --production",
    "start": "NODE_ENV=development ts-node index.ts",
    "start:dev": "NODE_ENV=development ts-node-dev --respawn index.ts",
    "prod": "NODE_ENV=production node ./build/index.js",
    "prod:dev": "NODE_ENV=development node ./build/index.js",
    "keypair:dev": "node ./modules/auth/generateKeyPair.js",
    "keypair:setup": "cp -r ./uploads ./build/uploads && mkdir ./build/modules/auth/keys",
    "keypair:generate": "node ./build/modules/auth/generateKeyPair.js",
    "remove:build": "rm -r ./build || true",
    "build": "yarn remove:build && tsc && yarn keypair:setup && yarn keypair:generate",
    "format:check": "prettier --check .",
    "format:write": "prettier --write .",
    "lint:check": "eslint .",
    "lint:fix": "eslint --fix .",
    "precommit": "lint-staged",
    "prepare": "husky install"
  },
  "dependencies": {},
  "devDependencies": {
    "@types/node": "^18.0.0",
    "@typescript-eslint/eslint-plugin": "^5.28.0",
    "@typescript-eslint/parser": "^5.28.0",
    "eslint": "^8.18.0",
    "eslint-config-google": "^0.14.0",
    "eslint-config-prettier": "^8.5.0",
    "husky": "^8.0.1",
    "lint-staged": "^13.0.2",
    "prettier": "^2.7.1",
    "ts-node": "^10.8.1",
    "ts-node-dev": "^2.0.0",
    "typescript": "^4.7.4"
  },
  "lint-staged": {
    "*.{js,ts,tsx}": [
      "eslint",
      "prettier --write"
    ],
    "*.json": [
      "prettier --write"
    ]
  }
}
```

```json
// .eslintrc.json

{
  "root": true,
  "env": {
    "es2021": true,
    "node": true,
    "browser": true
  },
  "extends": ["google", "prettier"],
  "parser": "@typescript-eslint/parser",
  "parserOptions": {
    "ecmaVersion": "latest",
    "sourceType": "module"
  },
  "plugins": ["@typescript-eslint"],
  "rules": {
    "no-console": "off",
    "require-jsdoc": 0,
    "new-cap": 0,
    "no-unused-vars": 0
  }
}
```

```json
// .prettierrc.json

{
  "trailingComma": "es5",
  "tabWidth": 2,
  "semi": false,
  "singleQuote": true
  ...
}
```

```bash
# Procfile

web: yarn prod
```

Ignore the required files
- .gitignore to ignore files from git
- .eslintignore to ignore files from eslint checks
- .prettierignore to ignore files from prettier checks
- .dockerignore to ignore files from docker builds
- .slugignore to ignore files from heroku builds

Use .env to store all the actual dependencies and .env.sample to give a glimpse of what all environment variables are required in the project. For example

```bash
# .env
AUTH_SECRET=thisisasupersecretauthsecretdonotdisclose

# .env.sample
AUTH_SECRET=
```

```json
// tsconfig.json

{
  "compilerOptions": {
    "target": "es2016", 
    "lib": [ "ES6" ],
    "module": "commonjs",
    "typeRoots": [ "./@types" ], 
    "allowJs": true,
    "checkJs": true,
    "outDir": "./build",
    "esModuleInterop": true,
    "forceConsistentCasingInFileNames": true,
    "strict": true, 
    "skipLibCheck": true,
    "baseUrl": "./",
  },
  "exclude": ["node_modules", "client"]
}

// the baseUrl: "./" can make our imports relative to the root directory and save from ../../../ syntax, we can use absolute-like imports. for example, import { User } from "modules/auth/user.model.ts" rather than "../../modules/auth/user.model.ts" 

// exclude the node_modules and client folders to opt out of type checkings in those folders, to speed up incremental builds
```

```bash
# .husky/pre-commit

#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

yarn precommit
```

After adding this file, you need to make this file executable. In linux, you can do something like (from the root of the project)
`sudo chmod +x ./.husky/pre-commit`  
requires root user permissions

After this step, on installing any npm package, there would be an additional message saying "Git Hooks Installed". This ensures, your git hooks are properly setup. These git hooks can be later used to enforce styles, run scripts (tests) before committing code to git.

### Setting up the boilerplate

